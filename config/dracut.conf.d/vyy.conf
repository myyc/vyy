# vyy dracut configuration
# For LUKS + btrfs + OSTree boot with Plymouth

# Build generic initramfs (not host-only) for distribution
hostonly="no"
hostonly_cmdline="no"

# Essential modules for LUKS + btrfs + OSTree boot
# Target setup: EFI -> /boot (unencrypted) -> LUKS -> btrfs subvolumes
add_dracutmodules=" crypt dm ostree plymouth vyy-ostree-fix "

# Filesystems (btrfs for root, vfat for EFI)
filesystems+=" btrfs ext4 vfat "

# Compress with zstd
compress="zstd"

# Include CPU microcode updates
early_microcode="yes"

# Plymouth theme
plymouth_theme="spinner"

# Kernel modules for NVMe and crypto
add_drivers+=" nvme nvme_core "

# Force erofs early for composefs support
force_drivers+=" erofs "

# Omit unnecessary modules
omit_dracutmodules+=" i18n bluetooth nfs iscsi fcoe fcoe-uefi nbd brltty "
omit_dracutmodules+=" multipath dmraid mdraid modsign busybox memstrack "
omit_dracutmodules+=" network-legacy network-manager network "

# Don't include all firmware - only what's needed
install_optional_items=""

# Omit drivers not needed for boot (can load later from rootfs)
# GPU (amdgpu needed for Plymouth, others not)
omit_drivers+=" nvidia nouveau radeon i915 xe intel_gtt "

# WiFi/Bluetooth - not needed in initramfs
omit_drivers+=" iwlwifi iwlmvm ath9k ath10k ath11k rtw88 rtw89 "
omit_drivers+=" mt76 mt7921 mt792x cfg80211 mac80211 "
omit_drivers+=" btusb btintel btrtl btbcm btmtk bluetooth "

# Sound - definitely not needed for boot
omit_drivers+=" snd snd_ soundwire_ snd_sof snd_hda snd_soc snd_acp snd_pci snd_rpl "

# USB peripherals
omit_drivers+=" uvcvideo hid-sony hid-playstation xpad joydev mousedev "

# Other not needed early
omit_drivers+=" kvm kvm_amd amdxdna wireguard tun nft_ nf_ "

# SCSI/storage not needed for NVMe boot
omit_drivers+=" ata_piix pata_ sata_sil sata_via ahci_platform "
omit_drivers+=" mpt3sas megaraid_ aacraid 3w- hpsa smartpqi "
omit_drivers+=" iscsi_ fcoe libfc lpfc qla2xxx bnx2fc "

# Watchdog - not needed for boot
omit_drivers+=" watchdog sp5100_tco iTCO_wdt "

# NLS codepages - only utf8 needed
omit_drivers+=" nls_cp nls_iso nls_koi "

# HID - keep only generic
omit_drivers+=" hid-a4tech hid-apple hid-belkin hid-cherry hid-chicony "
omit_drivers+=" hid-cypress hid-ezkey hid-gyration hid-kensington hid-lcpower "
omit_drivers+=" hid-logitech hid-microsoft hid-monterey hid-ortek hid-petalynx "
omit_drivers+=" hid-samsung hid-sunplus hid-topseed hid-uclogic hid-waltop "
